function checkPath(){let e=new URLSearchParams(window.location.search);if(!e.has("path")){e.set("path","/");let t=window.location.pathname+"?"+e.toString();return history.replaceState(null,"",t),"/"}return e.get("path")}function setPagePath(e){let t=new URLSearchParams(window.location.search);t.set("path",e);let l=window.location.pathname+"?"+t.toString();history.pushState(null,"",l)}function toggleLinkAttribute(e,t){let l=new URLSearchParams(window.location.search);t?l.set(e,""):l.delete(e);let a=window.location.pathname+"?"+l.toString();history.pushState(null,"",a)}function getSubPaths(e){e.startsWith("/")||(e="/"+e);let t=[],l=e.split("/").filter(e=>e),a="";for(let n=0;n<l.length;n++)t.push(a+="/"+l[n]);return t}async function getStorage(){try{let e=await fetch("/storage");if(!e.ok){let t=`Errore: ${e.status} - ${e.statusText}`;alert(t),window.location.reload();return}let l=await e.json();return l}catch(a){alert(`Si \xe8 verificato un problema: ${a.message}`),window.location.reload()}return null}async function reformatRequest(e,t){let l=`/reformat?old_path=${encodeURIComponent(e)}&new_path=${encodeURIComponent(t)}`;try{let a=await fetch(l);return a}catch(n){alert(`Si \xe8 verificato un problema: ${n.message}`),window.location.reload()}return null}async function deleteElement(e){let t=`/delete?target=${encodeURIComponent(e)}`;try{let l=await fetch(t,{method:"DELETE"});if(!l.ok){let a=`Errore: ${l.status} - ${l.statusText}`;alert(a),window.location.reload();return}let n=await l.json();return n}catch(i){alert(`Si \xe8 verificato un problema: ${i.message}`),window.location.reload()}return null}async function createFolder(e,t){let l=`/new/folder?path=${encodeURIComponent(e)}&name=${encodeURIComponent(t)}`;try{let a=await fetch(l,{method:"POST"});return a}catch(n){alert(`Si \xe8 verificato un problema: ${n.message}`),window.location.reload()}return null}async function getAvailableFiles(e){try{let t=await fetch("/upload/available-files",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(e)});return t}catch(l){alert(`Si \xe8 verificato un problema: ${l.message}`),window.location.reload()}return null}async function set_usage_bar(){let e=await getStorage();if(!e)return;let t=e.used_size,l=e.max_size,a=t/l*100;a=a.toFixed(1);let n=document.getElementById("storage-bar-progress");n.style.width=`${a}%`;let i=document.getElementById("storage-bar-info"),o=document.createElement("span"),r=document.createElement("span");o.className="storage-text",r.className="storage-percentage",o.innerHTML=`${formatFileSize(t)} / ${formatFileSize(l)}`,r.innerHTML=`${a}%`,i.innerHTML="",i.appendChild(o),i.appendChild(r)}function downloadFile(e){let t=new URL("/download",window.location.origin);t.searchParams.append("filepath",e);let l=document.createElement("a");l.href=t,l.download=e.split("/").pop(),l.target="_blank",document.body.appendChild(l),l.click(),document.body.removeChild(l)}async function loadFileList(e){let t=`/list?path=${encodeURIComponent(e)}`;try{let l=await fetch(t);if(!l.ok){let a=`Errore: ${l.status} - ${l.statusText}`;alert(a),window.location.reload();return}let n=await l.json();return n}catch(i){alert(`Si \xe8 verificato un problema: ${i.message}`),window.location.reload()}return null}function setMainDragDrop(e){let t=document.getElementById("main-total-div");t.ondragover=function(e){e.preventDefault(),e.stopPropagation();let l=Array.from(e.dataTransfer.items).some(e=>"file"===e.kind);l&&t.classList.add("dragged-over")},t.ondragleave=function(e){let l=Array.from(e.dataTransfer.items).some(e=>"file"===e.kind);l&&t.classList.remove("dragged-over")},t.ondrop=async function(l){l.preventDefault(),l.stopPropagation(),t.classList.remove("dragged-over");let a=Array.from(l.dataTransfer.items).some(e=>"file"===e.kind);a&&await uploadFilesFromDragEvent(l,e)}}async function loadFolderStructure(e,t,l){if(0===l){let a=document.getElementById("root-node");if(a.onclick=()=>{setPagePath("/"),reloadFilesRequest()},a.ondragover=function(e){e.preventDefault(),e.stopPropagation(),a.classList.add("dragged-over")},a.ondragleave=function(e){a.classList.remove("dragged-over")},a.ondrop=async function(e){e.preventDefault(),e.stopPropagation(),a.classList.remove("dragged-over");let t=Array.from(e.dataTransfer.items).some(e=>"file"===e.kind);t?await uploadFilesFromDragEvent(e,"/"):await moveSelectedTo("/")},t.length<=1){a.className="node node-main current";return}a.className="node node-main current-less"}if(l>=t.length)return;let n=await loadFileList(t[l]);for(let i of n=n?n.files:[])if(!i.file){let o=document.createElement("li"),r=document.createElement("div");r.className="node",r.onclick=()=>{setPagePath(i.path),reloadFilesRequest()},r.ondragover=function(e){e.preventDefault(),e.stopPropagation(),r.classList.add("dragged-over")},r.ondragleave=function(e){r.classList.remove("dragged-over")},r.ondrop=async function(e){e.preventDefault(),e.stopPropagation(),r.classList.remove("dragged-over");let t=Array.from(e.dataTransfer.items).some(e=>"file"===e.kind);t?await uploadFilesFromDragEvent(e,i.path):await moveSelectedTo(i.path)};let s=i.path===t[l+1],d=i.path===t[t.length-1];if(d?r.classList.add("current"):s&&r.classList.add("current-less"),o.appendChild(r),s&&!d){let c=document.createElement("ul");await loadFolderStructure(c,t,l+1),o.appendChild(c)}e.appendChild(o)}}async function reloadFilesRequest(){filepath=checkPath();let e=new URLSearchParams(window.location.search),t="true"===e.get("notfound","false"),l=!0,a=[];if(t||(l="not_found"in(a=await loadFileList(filepath))),reloadFiles(a,filepath,l),uploadButtons(filepath),l){let n=document.getElementById("main-node-group");n.innerHTML="",await loadFolderStructure(n,["/"],0)}else{let i=getSubPaths(filepath);i=["/"].concat(i);let o=document.getElementById("main-node-group");o.innerHTML="",await loadFolderStructure(o,i,0)}await set_usage_bar(),tree_auto_scroll()}function generateFilePathHTML(e,t,l){let a=[];""===e||"/"===e||(a=e.replace(/^\/|\/$/g,"").split("/"));let n=document.createElement("div");n.className="file-path-container";let i=document.createElement("div");if(i.id="file-path-return",t){let o=document.createElement("button");o.className="upload-file file-path-return",o.style="margin-right:10px;";let r=document.createElement("i");r.className="fa fa-level-up return-span",r.setAttribute("aria-hidden","true"),o.appendChild(r),o.onclick=()=>{window.history.back()},i.appendChild(o)}else if("/"!=e&&""!=e){let s=document.createElement("button");s.className="upload-file file-path-return",s.style="margin-right:10px;";let d=["/"].concat(getSubPaths(e));if(s.onclick=()=>{setPagePath(d[d.length-2]),reloadFilesRequest()},l){let c=document.createElement("i");c.className="fa fa-level-up return-span",c.setAttribute("aria-hidden","true"),s.appendChild(c),i.appendChild(s)}}let p=document.createElement("div");if(p.className="file-path-info no-text-select",l||p.classList.add("dark"),t){let f=document.createElement("span");f.className="path-separator error",f.textContent="Percorso non trovato",p.appendChild(f)}else{let m=document.createElement("span");m.className="path-folder",m.textContent="/",l?(m.onclick=()=>{setPagePath("/"),reloadFilesRequest()},m.ondragover=function(e){e.preventDefault(),e.stopPropagation(),m.classList.add("dragged-over")},m.ondragleave=function(e){m.classList.remove("dragged-over")},m.ondrop=async function(e){e.preventDefault(),e.stopPropagation(),m.classList.remove("dragged-over");let t=Array.from(e.dataTransfer.items).some(e=>"file"===e.kind);t?await uploadFilesFromDragEvent(e,"/"):await moveSelectedTo("/")}):m.classList.add("no-selection"),p.appendChild(m);let u=document.createElement("span");u.className="path-separator",u.textContent=">",p.appendChild(u),a.forEach((t,a)=>{let n=document.createElement("span");n.className="path-folder",n.textContent=t,l?(n.onclick=()=>{setPagePath(getSubPaths(e)[a]),reloadFilesRequest()},n.ondragover=function(e){e.preventDefault(),e.stopPropagation(),n.classList.add("dragged-over")},n.ondragleave=function(e){n.classList.remove("dragged-over")},n.ondrop=async function(t){t.preventDefault(),t.stopPropagation(),n.classList.remove("dragged-over");let l=Array.from(t.dataTransfer.items).some(e=>"file"===e.kind);l?await uploadFilesFromDragEvent(t,getSubPaths(e)[a]):await moveSelectedTo(getSubPaths(e)[a])}):n.classList.add("no-selection"),p.appendChild(n);let i=document.createElement("span");i.className="path-separator",i.textContent=">",p.appendChild(i)})}return("/"!=e&&""!=e||t)&&n.appendChild(i),n.appendChild(p),n}function formatFileSize(e){let t=["B","KB","MB","GB"];if(0===e)return`0 ${t[0]}`;let l=Math.min(3,Math.floor(Math.log(e)/Math.log(1024)));return(e/Math.pow(1024,l)).toFixed(2)+" "+t[l]}function generateFilesHTML(e){let t=e.files,l=[];return t.forEach((e,a)=>{let n=document.createElement("div");n.className="file-container nopadding",n.setAttribute("index",a),n.setAttribute("filePath",e.path),n.setAttribute("fileName",e.name),n.draggable=!0;let i=document.createElement("div");i.className="file-info vertical-center";let o=e=>{if(e.ctrlKey)n.hasAttribute("selected")?toggleSelected(n,!1):toggleSelected(n,!0);else if(e.shiftKey){let t=document.getElementById("main-files-div").querySelectorAll(".file-container"),l=-1,i=-1;t.forEach(e=>{let t=parseInt(e.getAttribute("index"),10);e.hasAttribute("selected")&&(-1===i&&(i=t),l=t)}),-1!==l&&l!==a&&i!==a&&t.forEach(e=>{let t=parseInt(e.getAttribute("index"),10);a>l?t>=l&&t<=a&&e.setAttribute("selected",""):t<=i&&t>=a&&e.setAttribute("selected","")})}else deselectAll(),toggleSelected(n,!0)};if(e.file){let r=document.createElement("span");r.className="file-name no-text-select add-file-icon filemargin",r.innerHTML=e.name;let s=e.name.split("."),d=s.length>1?s.pop():"",c=handleFileOpenExtension(i,d,e.size,e.path,e.name);isTouchDevice()?i.onclick=c:(i.onclick=o,i.ondblclick=c);let p=document.createElement("span");p.className="file-size no-text-select",p.innerHTML=formatFileSize(e.size);let f=document.createElement("span");f.className="file-date no-text-select",f.innerHTML=e.creation_date,i.appendChild(r),i.appendChild(p),i.appendChild(f)}else{let m=document.createElement("span");m.className="file-name no-text-select add-folder-icon filemargin",m.innerHTML=e.name;let u=()=>{setPagePath(e.path),reloadFilesRequest()};isTouchDevice()?i.onclick=u:(i.onclick=o,i.ondblclick=u);let g=document.createElement("span");g.className="file-date no-text-select",g.innerHTML=e.creation_date,i.appendChild(m),i.appendChild(g),i.ondragover=function(e){n.hasAttribute("selected")||(e.preventDefault(),e.stopPropagation(),n.classList.add("dragged-over"))},i.ondragleave=function(e){n.hasAttribute("selected")||n.classList.remove("dragged-over")},i.ondrop=async function(t){t.preventDefault(),t.stopPropagation(),n.classList.remove("dragged-over");let l=Array.from(t.dataTransfer.items).some(e=>"file"===e.kind);l?await uploadFilesFromDragEvent(t,e.path):await moveSelectedTo(e.path)}}let h=document.createElement("div");h.className="file-actions";let y=document.createElement("div");y.className="file-actions-dropdown-element";let E=document.createElement("div");E.className="file-actions-dropdown-open";let v=document.createElement("button");v.className="file-action-button",v.ariaLabel="Download",v.onclick=()=>{downloadFile(e.path)};let L=document.createElement("i");L.className="fa fa-download",v.appendChild(L);let b=v.cloneNode(!0);b.onclick=()=>{downloadFile(e.path)};let k=document.createElement("button");function w(){let t=document.getElementById("file-rename-modal"),l=document.getElementById("file-rename-title"),a=document.getElementById("file-rename-input"),n=document.getElementById("file-rename-close"),i=document.getElementById("file-rename-save"),o=document.getElementById("file-rename-error");l.innerHTML=e.file?"Rinomina file":"Rinomina cartella",a.placeholder=e.name,a.value=e.name,a.addEventListener("input",()=>{a.value=a.value.replace(/[^a-zA-Z0-9àèìòùÀÈÌÒÙáéíóúÁÉÍÓÚäëïöüÄËÏÖÜ._\-+@& ]/g,"_"),o.style.display="none"}),o.style.display="none";let r=()=>{toggleLinkAttribute("modalOpen",!1),t.style.display="none"};t.onclick=e=>{e.target===t&&r()},n.onclick=()=>{r()},i.onclick=async()=>{let t=e.path.split("/");t[t.length-1]=a.value?a.value:e.name;let l=t.join("/"),n=await reformatRequest(e.path,l);if(n.ok)r(),reloadFilesRequest();else try{let i=await n.json(),s=i.type;switch(s){case 1:o.innerHTML="Errore durante la richiesta";break;case 2:o.innerHTML="File non trovato";break;case 3:o.innerHTML="Elemento con stesso nome gi\xe0 presente";break;default:o.innerHTML="Errore del server"}o.style.display="block"}catch(d){alert(`Si \xe8 verificato un problema: ${d.message}`),window.location.reload()}},toggleLinkAttribute("modalOpen",!0),t.style.display="flex"}k.className="file-action-button",k.ariaLabel="Rinomina",k.onclick=w;let F=document.createElement("i");F.className="fa fa-edit",k.appendChild(F);let T=k.cloneNode(!0);T.onclick=w;let C=document.createElement("button");function B(){let t=document.getElementById("delete-file-modal"),l=document.getElementById("delete-file-title"),a=document.getElementById("delete-file-close"),n=document.getElementById("delete-file-save"),i=document.getElementById("delete-file-cancel"),o=document.getElementById("delete-file-name");l.innerHTML=e.file?"Elimina file":"Elimina cartella";let r=document.createElement("div");r.className="file-container modal-upload",r.innerHTML=e.name,o.innerHTML="",o.appendChild(r),i.style.display="inline-block";let s=()=>{toggleLinkAttribute("modalOpen",!1),t.style.display="none"};t.onclick=e=>{e.target===t&&s()},a.onclick=()=>{s()},i.onclick=()=>{s()},n.onclick=async()=>{await deleteElement(e.path),s(),reloadFilesRequest()},toggleLinkAttribute("modalOpen",!0),t.style.display="flex"}C.className="file-action-button",C.ariaLabel="Elimina",C.onclick=B;let P=document.createElement("i");P.className="fa fa-trash",C.appendChild(P);let N=C.cloneNode(!0);N.onclick=B;let I=document.createElement("button");I.className="file-action-button",I.ariaLabel="Menu";let $=document.createElement("i");$.className="fa fa-bars",I.appendChild($),h.appendChild(v),h.appendChild(k),h.appendChild(C),y.appendChild(b),y.appendChild(T),y.appendChild(N),I.onclick=()=>{y.classList.contains("show")?(y.classList.remove("show"),I.classList.remove("show")):(y.classList.add("show"),I.classList.add("show"));let e=I.getBoundingClientRect();y.classList.contains("show")&&(a>=t.length-1?y.style.top=`${e.bottom-50}px`:y.style.top=`${e.bottom}px`,y.style.left=`${e.left-.875}px`)},document.addEventListener("click",function e(t){y.contains(t.target)||I.contains(t.target)||(y.classList.remove("show"),I.classList.remove("show"))}),window.addEventListener("resize",()=>{y.classList.remove("show"),I.classList.remove("show")}),E.appendChild(I),n.appendChild(i),n.appendChild(h),n.appendChild(E),n.appendChild(y),l.push(n)}),l}function reloadFiles(e,t,l){main_files_div=document.getElementById("main-files-div");let a=generateFilePathHTML(t,l,!0);if(l){main_files_div.innerHTML="",main_files_div.appendChild(a);return}let n=generateFilesHTML(e);main_files_div.innerHTML="",main_files_div.appendChild(a),n.forEach((e,t)=>{main_files_div.appendChild(e)}),setMainDragDrop(t)}let filesToProcessList=[],currentFileID=1,newFilesLoaded=!1,uploadingFiles=!1;async function uploadFilesFromListRecursive(){for(;;){let e=filesToProcessList.find(e=>!e.waitingfor&&!e.alreadydone&&!e.replaceerror&&!e.storageerror);if(!e){uploadingFiles=!1,newFilesLoaded||(reloadFilesRequest(),newFilesLoaded=!0),await new Promise(e=>setTimeout(e,100));continue}uploadingFiles=!0,newFilesLoaded=!1,await updateUploadElement(e)}}function removeFilesElementById(e){let t=filesToProcessList.findIndex(t=>t.id===e);t>-1&&filesToProcessList.splice(t,1)}function resetDoneFiles(){filesToProcessList=filesToProcessList.filter(e=>!(e.alreadydone||e.replaceerror||e.storageerror))}async function updateUploadElement(e){let t=e.container,l=e.file,a=new FormData;a.append("file",l);let n=e.path,i=new Promise((l,i)=>{let o=new XMLHttpRequest;o.open("POST",`/upload/file?path=${encodeURIComponent(n)}`,!0),o.upload.addEventListener("progress",e=>{if(e.lengthComputable){let l=e.loaded/e.total*100;setLoadingFilePercentage(t,l)}}),o.onload=()=>{if(o.status>=200&&o.status<300){let a=JSON.parse(o.responseText);setLoadingFileComplete(t),e.alreadydone=!0,l(a)}else i(Error(`Upload failed: ${o.statusText}`))},o.onerror=()=>{i(Error("Network error"))},o.send(a)});try{await i}catch(o){alert("Error uploading file"),window.location.reload()}}function removeButtonFromReplaceContainer(e){let t=e.children;for(let l=t.length-1;l>=0;l--){let a=t[l];("replace-file-button"===a.id||"cancel-file-button"===a.id)&&e.removeChild(a)}}function documentDisplayFileList(){let e=document.getElementById("new-files-uploading-list");for(let t of(e.innerHTML="",filesToProcessList)){if(removeButtonFromReplaceContainer(t.container),t.waitingfor||t.replaceerror){let l=document.createElement("button");l.className="file-action-button cancel-files-colored",l.id="cancel-file-button",l.ariaLabel="Annulla",l.onclick=()=>{removeFilesElementById(t.id),checkTotalReplaceButton(),documentDisplayFileList()};let a=document.createElement("i");a.className="fa-solid fa-xmark",l.appendChild(a),t.container.appendChild(l)}if(t.waitingfor){let n=document.createElement("button");n.className="file-action-button replace-files-colored",n.id="replace-file-button",n.ariaLabel="Sovrascrivi",n.onclick=()=>{let e=filesToProcessList.findIndex(e=>e.id===t.id);filesToProcessList[e].waitingfor=!1,removeButtonFromReplaceContainer(filesToProcessList[e].container),checkTotalReplaceButton()};let i=document.createElement("i");i.className="fa fa-rotate-right",n.appendChild(i),t.container.appendChild(n)}e.appendChild(t.container)}}function checkTotalReplaceButton(){let e=filesToProcessList.findIndex(e=>!0===e.waitingfor);replaceButton=document.getElementById("main-replace-button"),-1!==e?(replaceButton.style="display:flex",replaceButton.onclick=()=>{for(let e of filesToProcessList)e.waitingfor&&(removeButtonFromReplaceContainer(e.container),e.waitingfor=!1);checkTotalReplaceButton()}):replaceButton.style.display="none"}async function onFileSelect(e,t,l){let a=[];a=t?t.target.files:l;let n=[],i=[],o=0;for(let r of a){let s=document.createElement("div");s.className="file-container modal-upload";let d=document.createElement("div");d.className="file-name no-text-select add-file-icon no-margin",d.innerHTML=r.name,s.appendChild(d);let c={id:currentFileID++,path:e,file:r,waitingfor:!1,wasreplaced:!1,replaceerror:!1,alreadydone:!1,storageerror:!1,container:s},p;p=r.webkitRelativePath&&""!==r.webkitRelativePath?e.replace(/^\/+/,"")+"/"+r.webkitRelativePath:e.replace(/^\/+/,"")+"/"+r.name,n.push({id:c.id,filepath:p}),o+=r.size,i.push(c)}let f=await getAvailableFiles({data:n,size:o});if(f){try{if(f.ok){let m=await f.json();if(m.storageError){let u=document.createElement("div");u.className="file-container modal-upload transparent-red";let g=document.createElement("div");g.className="file-name no-text-select storageerror add-error-icon no-margin",g.innerHTML="Memoria esaurita",u.appendChild(g),i=[{id:currentFileID++,file:null,waitingfor:!1,wasreplaced:!1,replaceerror:!0,alreadydone:!1,storageerror:!0,container:u},]}else{let h=m.responseJSON;for(let y of h){let E=y.id,v=y.isfile,L=y.isfolder,b=i.find(e=>e.id===E);v?(b.waitingfor=!0,b.wasreplaced=!0,b.container.classList.add("yellow-transparent-bg")):L&&(b.replaceerror=!0,b.container.classList.add("red-transparent-bg"))}}}else alert("Errore durante la preparazione al caricamento dei file"),window.location.reload()}catch(k){alert("Errore durante la preparazione al caricamento dei file: "+k.message),window.location.reload()}filesToProcessList=filesToProcessList.concat(i),documentDisplayFileList(),checkTotalReplaceButton()}}function uploadButtons(e){let t=document.getElementById("upload-buttons-container"),l=document.createElement("button"),a=document.createElement("button");l.className="upload-file",a.className="upload-folder",l.id="upload-file-button",l.onclick=()=>{let t=document.getElementById("upload-file-modal"),l=document.getElementById("upload-file-close"),a=document.getElementById("upload-file-cancel"),n=document.getElementById("upload-file-pathbar"),i=generateFilePathHTML(e,!1,!1);i.id="upload-file-pathbar",n.parentNode.replaceChild(i,n);let o=document.getElementById("file-selection-input-button"),r=document.getElementById("folder-selection-input-button");checkTotalReplaceButton();let s=document.createElement("input");s.type="file",s.id="file-selection-input",s.style.display="none",s.multiple=!0;let d=document.createElement("input");d.type="file",d.id="folder-selection-input",d.style.display="none",d.webkitdirectory=!0;let c=document.getElementById("file-selection-input"),p=document.getElementById("folder-selection-input");c.parentNode.replaceChild(s,c),p.parentNode.replaceChild(d,p),o.onclick=()=>s.click(),r.onclick=()=>d.click(),resetDoneFiles(),documentDisplayFileList(),s.addEventListener("change",async t=>onFileSelect(e,t)),d.addEventListener("change",async t=>onFileSelect(e,t)),t.onclick=e=>{e.target===t&&(t.style.display="none")},l.onclick=()=>{t.style.display="none"},a.onclick=()=>{t.style.display="none"},t.style.display="flex"},a.onclick=()=>{let t=document.getElementById("folder-create-modal"),l=document.getElementById("folder-create-input"),a=document.getElementById("folder-create-close"),n=document.getElementById("folder-create-save"),i=document.getElementById("folder-create-error");i.style.display="none",t.onclick=e=>{e.target===t&&(t.style.display="none")},a.onclick=()=>{t.style.display="none"},l.addEventListener("input",()=>{l.value=l.value.replace(/[^a-zA-Z0-9àèìòùÀÈÌÒÙáéíóúÁÉÍÓÚäëïöüÄËÏÖÜ._\-+@& ]/g,"_"),i.style.display="none"}),l.value="",n.onclick=async()=>{let a=await createFolder(e,l.value);if(a.ok)t.style.display="none",reloadFilesRequest();else try{let n=await a.json(),o=n.type;switch(o){case 1:i.innerHTML="Nome cartella non valido";break;case 2:i.innerHTML="Cartella gi\xe0 esistente";break;default:i.innerHTML="Errore del server"}i.style.display="block"}catch(r){alert(`Si \xe8 verificato un problema: ${r.message}`),window.location.reload()}},t.style.display="flex"};let n=document.createElement("span");n.className="icon-container";let i=n.cloneNode(!0),o=document.createElement("i"),r=document.createElement("i");o.className="fas fa-file-upload",r.className="fas fa-folder-plus",n.appendChild(o),i.appendChild(r);let s=document.createElement("span"),d=document.createElement("span");s.innerHTML="Carica file",d.innerHTML="Crea cartella",l.appendChild(n),a.appendChild(i),l.appendChild(s),a.appendChild(d),t.innerHTML="",t.appendChild(l),t.appendChild(a)}function getSelectedElementsPaths(){return Array.from(document.querySelectorAll(".files .file-container[selected]"),e=>[e.getAttribute("filePath"),e.getAttribute("fileName")])}async function moveSelectedTo(e){e.endsWith("/")||(e+="/");let t=getSelectedElementsPaths(),l=[];for(let[a,n]of t){let i=await reformatRequest(a,e+n);if(!i)return;if(!i.ok)try{let o=await i.json(),r=o.type;l.push({name:n,path:a,type:r})}catch(s){alert(`Si \xe8 verificato un problema: ${s.message}`),window.location.reload()}}reloadFilesRequest();let d=[];for(let c of l)switch(c.type){case 3:d.push(c.name);break;case 1:console.log("Request error",c.name);break;case 2:console.log("File not found",c.name);break;default:console.log("Server error",c.name)}if(d.length>0){let p=document.getElementById("delete-file-modal"),f=document.getElementById("delete-file-title"),m=document.getElementById("delete-file-close"),u=document.getElementById("delete-file-save"),g=document.getElementById("delete-file-cancel"),h=document.getElementById("delete-file-name");f.innerHTML="File gi\xe0 presenti",h.innerHTML="",g.style.display="none",d.forEach((e,t)=>{(nameTag=document.createElement("div")).classList="file-container modal-upload no-text-select",nameTag.innerHTML=e,h.appendChild(nameTag)});let y=()=>{toggleLinkAttribute("modalOpen",!1),p.style.display="none"};p.onclick=e=>{e.target===p&&y()},m.onclick=y,u.onclick=y,toggleLinkAttribute("modalOpen",!0),p.style.display="flex"}}function readWebKitEntry(e,t=""){return new Promise((l,a)=>{if(e.isFile)e.file(e=>l([e]),e=>a(e));else if(e.isDirectory){let n=e.createReader();n.readEntries(n=>{let i=n.map(l=>readWebKitEntry(l,t+e.name+"/"));Promise.all(i).then(e=>{l(e.flat())}).catch(e=>{alert("Errore durante la lettura del file."),window.location.reload(),a(e)})})}else l([])})}async function uploadFilesFromDragEvent(e,t){let l=[],a=e.dataTransfer.items,n=[];for(let i of a){let o=i.webkitGetAsEntry();o&&n.push(readWebKitEntry(o))}let r=await Promise.all(n);l=r.flat();let s=document.getElementById("upload-file-button");s.click(),await onFileSelect(t,null,l)}window.addEventListener("beforeunload",function(e){var t="Il caricamento in corso dei file verr\xe0 annullato, continuare?";return uploadingFiles?(e.preventDefault(),e.returnValue=t,t):null}),uploadFilesFromListRecursive(),document.addEventListener("keydown",e=>{if("Delete"===e.key){let t=getSelectedElementsPaths(),l=document.getElementById("delete-file-modal"),a=document.getElementById("delete-file-title"),n=document.getElementById("delete-file-close"),i=document.getElementById("delete-file-save"),o=document.getElementById("delete-file-cancel"),r=document.getElementById("delete-file-name");a.innerHTML="Elimina",r.innerHTML="",o.style.display="inline-block",t.forEach(([e,t],l)=>{(nameTag=document.createElement("div")).classList="file-container modal-upload no-text-select",nameTag.innerHTML=t,r.appendChild(nameTag)});let s=()=>{toggleLinkAttribute("modalOpen",!1),l.style.display="none"};l.onclick=e=>{e.target===l&&s()},n.onclick=()=>{s()},o.onclick=()=>{s()},i.onclick=async()=>{t.forEach(async([e,t],l)=>{await deleteElement(e)}),s(),reloadFilesRequest()},toggleLinkAttribute("modalOpen",!0),l.style.display="flex"}}),window.onpopstate=()=>{reloadFilesRequest();let e=new URLSearchParams(window.location.search);if(!e.has("modalOpen")){let t=document.querySelectorAll(".modal-background");t.forEach(e=>{e.style.display="none"})}};